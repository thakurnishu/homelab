apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: onyx
spec:
  values:
    ingress:
      enabled: true
      className: traefik
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt-prod
      # Onyx chart uses specific keys for api and webserver hosts
      webserver:
        host: onyx.nishantlabs.cloud
      api:
        host: onyx-api.nishantlabs.cloud
    
    # Resource tuning for constrained environment (2 vCPU, 8GB RAM total)
    # Onyx budget: ~1.5 vCPU, ~6GB RAM (leaving space for OS + other services)
    
    # Vespa (Vector DB) - Most memory-intensive component
    vespa:
      resources:
        requests:
          cpu: 500m
          memory: 2Gi
        limits:
          cpu: 1000m
          memory: 3Gi
      volumeClaimTemplates:
        - metadata:
            name: vespa-storage
          spec:
            resources:
              requests:
                storage: 5Gi  # Reduced for smaller deployment
    
    # PostgreSQL (CNPG)
    postgresql:
      cluster:
        instances: 1
        storage:
          size: 3Gi  # Minimal storage
    
    # Model Servers - Significantly reduced
    inferenceCapability:
      resources:
        requests:
          cpu: 250m
          memory: 768Mi
        limits:
          cpu: 500m
          memory: 1Gi
    
    indexCapability:
      resources:
        requests:
          cpu: 250m
          memory: 768Mi
        limits:
          cpu: 500m
          memory: 1Gi
    
    # API Server
    api:
      resources:
        requests:
          cpu: 100m
          memory: 384Mi
        limits:
          cpu: 300m
          memory: 768Mi
    
    # Web Server
    webserver:
      resources:
        requests:
          cpu: 50m
          memory: 192Mi
        limits:
          cpu: 200m
          memory: 384Mi
    
    # Celery Workers - Minimal footprint
    celery_worker_heavy:
      resources:
        requests:
          cpu: 100m
          memory: 192Mi
        limits:
          cpu: 300m
          memory: 384Mi
    
    celery_worker_docprocessing:
      resources:
        requests:
          cpu: 100m
          memory: 384Mi
        limits:
          cpu: 300m
          memory: 768Mi
    
    celery_worker_light:
      resources:
        requests:
          cpu: 50m
          memory: 192Mi
        limits:
          cpu: 200m
          memory: 384Mi
    
    celery_worker_primary:
      resources:
        requests:
          cpu: 100m
          memory: 384Mi
        limits:
          cpu: 300m
          memory: 768Mi
    
    celery_beat:
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
        limits:
          cpu: 200m
          memory: 256Mi
    
    # Redis - Minimal
    redis:
      redisStandalone:
        resources:
          requests:
            cpu: 25m
            memory: 48Mi
          limits:
            cpu: 100m
            memory: 128Mi
      storageSpec:
        volumeClaimTemplate:
          spec:
            resources:
              requests:
                storage: 256Mi  # Minimal cache storage
    
    # MinIO - Reduced storage
    minio:
      persistence:
        size: 5Gi  # Minimal object storage
